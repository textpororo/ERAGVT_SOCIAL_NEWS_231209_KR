;衣装データベース(カスタマイズ)圧縮のための共通部切り出し
;ARG:参照キャラ
;ID:衣装ID
;MODE:データベースから取得するパラメータ
;SHOPR:
;	データ文字列から検索して数値切り出したいだけ(ふつうの言語におけるマッチ)だがERAではえらく回りくどい事になってしまっている
;	これなら순종적にsplitしてループで回した方が分かりやすいかもしれないなあ
@CLOTH_HOSEI(ARG,ID,MODE,SHOPR)
#DIM ID,1
#DIMS MODE,1
#DIM SHOPR,1
;発見位置
	#DIM sp,1
	#DIM ep,1
	;区切り文字
	#DIM sep,1
	;関数個別呼び必須フラグ(分岐条件が特殊な場合…袴の「アウター無しなら回避上昇」など)
	#DIM needcall,1
;結果
#DIM res,1

;스테이터스補正文字列の取得
TRYCCALLFORM CLOTH_STATUS_{ID}
CATCH
	SAVESTR:0'=""
ENDCATCH
LOCALS'=SAVESTR:0

IF LOCALS==""
	;
ENDIF

sp=-1
ep=-1
sep=-1
needcall=-1
res=-99999

;●通常時のデータを検索
STRFIND LOCALS,MODE,0
sp=RESULT

IF sp>-1
	;ポインタをキーワード直後(＝パラメータ記述位置)に移動
	STRLENS ""+mode
	sp+=RESULT

	;個別に関数を呼ぶ必要がある(複雑な分岐条件を持つ)場合
	STRFIND LOCALS,"!",sp
	IF RESULT==sp
		CALLFORM CLOTH_HOSEI_%MODE%_{ID}
		res=RESULT
	;通常の文字列データで指定されている場合
	ELSE

		;変身後パラメータ変動する場合
		STRFIND LOCALS,"@",sp
		ep=RESULT
		;見つけた"@"が区切り文字より右にあったら別項目への誤爆なのでキャンセル
		STRFIND LOCALS,",",sp
		sep=RESULT
		SIF ep>sep
			ep=-1


		;PRINTL
		;PRINTFORML %MODE%:%LOCALS%⇒{sp},{ep-sp}=★{res}

		;変身後データありの場合
		IF ep>-1
			SUBSTRING LOCALS,sp,ep-sp
			res=toint(RESULTS)
			;変身中
			IF CFLAG:ARG:1>0
				sp=ep+1
				STRFIND LOCALS,",",sp
				ep=RESULT
				SUBSTRING LOCALS,sp,ep-sp

				res=toint(RESULTS)

			ENDIF
		;変身後データなしの場合
		ELSE
			STRFIND LOCALS,",",sp
			ep=RESULT
			SUBSTRING LOCALS,sp,ep-sp

			res=toint(RESULTS)

		ENDIF
	ENDIF

	;PRINTFORML %MODE%:%LOCALS%⇒{sp},{ep-sp}=★{res}

ENDIF


;●補正発見できず→パラメータ毎のデフォルト値を返す
IF res==-99999
	SIF SHOPR == 1
		RETURN res
	IF MODE=="KOUGEKI" || MODE=="BOUGYO" || MODE=="BINSYOU" || MODE=="CHISEI" || MODE=="SEITAISEI" || MODE=="YUDAN" || MODE=="LIQUID" || MODE=="WAVE" || MODE=="SHYNESS"
		res=100
	ELSEIF MODE=="TAIRYOKU" || MODE=="KIRYOKU" 
		res=95
	ELSEIF MODE=="DEF"
		IF ID >= 300 && ID <= 400
			res=DEFAULT_INNER_DEF
		ELSE
			res=DEFAULT_OUTER_DEF
		ENDIF
	ELSEIF MODE=="SLOT"
		;正の値ならｎ個の汎用スロット、0なら固有カスタマイズ、-1なら完全にカスタマイズ無し
		res=0
	ELSE
		res=0
	ENDIF
;●補正発見時
ELSE
	;
ENDIF



;●パラメータの種類に応じて補正を計算
;　ただし「装備無し」の場合はEQUIPに衣装カスタマイズデータが存在しないため無条件でデフォルト値を返す
IF ID==0
	RETURN res
ENDIF
;重装・軽装레벨
IF CFLAG:1 == 0 && ID >= 100 && ID <= 199
	LOCAL = ID - 100
ELSE
	LOCAL = ID
ENDIF
IF MODE=="HP"
	;デフォルトで耐久を持たない衣装はノータッチ
	IF res!=-1
		res += 5 * (FIGURE_SPLIT(EQUIP:LOCAL,11) - FIGURE_SPLIT(EQUIP:LOCAL,10))
	ENDIF
ELSEIF MODE=="HIT"
	res *=-1
	res += 1 * (FIGURE_SPLIT(EQUIP:LOCAL,10) - FIGURE_SPLIT(EQUIP:LOCAL,11))
;下着保護・挿入抵抗
ELSEIF MODE=="DEF"
	res -= 5 * (FIGURE_SPLIT(EQUIP:LOCAL,13) - FIGURE_SPLIT(EQUIP:LOCAL,12))

ENDIF



RETURN res







@CLOTH_CUSTOMIZE_OPTION_DRAW(ID,ARG)
#DIM CUSTOM, 9
#DIM ID
#DIM EQUIPID
RESULT = 0
IF ID >= 100 && ID <= 199
	EQUIPID = ID - (CFLAG:1==0 ?100 #0)
ELSE
	EQUIPID = ID
ENDIF

;PRINTFORML {ARG}:{EQUIPID}= {EQUIP:ARG:EQUIPID}

REPEAT 9
	CUSTOM:COUNT = FIGURE_SPLIT(EQUIP:ARG:EQUIPID, COUNT + 1)
REND
TRYCCALLFORM CLOTH_CUSTOMIZE_OPTION_DRAW_{ID}(CUSTOM,EQUIPID,ARG)
CATCH
	PRINTL
	;PRINTFORML CLOTH_CUSTOMIZE_OPTION_DRAW_{ID}がありません
ENDCATCH



@CLOTH_CUSTOMIZE_OPTION_COMMON(ID,ARG,ARGS:0,ARGS:1,ARGS:2,ARGS:3,ARGS:4,ARGS:5,ARGS:6,ARGS:7,ARGS:8,ARGS:9)
;装備ID(ただし-999ならループ内から呼び出された判定関数)
#DIM ID,1

#DIM 項目数,1
#DIM 選択不可フラグ,10
#DIMS カテゴリ,1
#DIMS 補足テキスト,1

;ループから呼び出している場合
IF ID==-999
	;選択不可カテゴリの入力のみ切る
	$LOOP
	INPUT
	IF (RESULT % 10 == 0) && RESULT>=0 && RESULT <=項目数*10 && 選択不可フラグ:(RESULT/10)==1
		CLEARLINE 1
		GOTO LOOP
	ELSE
		;CLEARLINE 1
		;CLEARLINE MAXNUM+5
		RETURN RESULT
	ENDIF
ENDIF

項目数=8
FOR LOCAL,0,10,1
	IF ARGS:LOCAL=="@@"
		項目数=LOCAL-1
		BREAK
	ENDIF

	LOCALS'=ARGS:LOCAL
	IF LOCALS==""
		選択不可フラグ:LOCAL=1
		PRINTL
		CONTINUE
	ENDIF

	LOCAL:1=strfind(LOCALS,"!!")
	IF strfind(LOCALS,"!!")>-1
		選択不可フラグ:LOCAL=1
		REPLACE LOCALS,"^(.+)!!.+$",""
		カテゴリ'=SUBSTRING(LOCALS,0,LOCAL:1)
		REPLACE LOCALS,"^.+!!(.+)$",""
		補足テキスト'=SUBSTRING(LOCALS,2+LOCAL:1)
		SETCOLOR 105,105,105
	ELSE
		選択不可フラグ:LOCAL=0
		カテゴリ'=LOCALS
		補足テキスト'=""
		RESETCOLOR
	ENDIF

	PRINTFORML  [{LOCAL*10}]% "",LOCAL==0 ? 1 # 0%%カテゴリ,20,LEFT%%補足テキスト%
NEXT
RESETCOLOR

SIF ID>=0 && ID<=199 && CFLAG:ARG:1 > 0
	PRINTFORML  [{(項目数+1)*10}]追加装備
PRINTL 

PRINTL  [90]初期化

IF (ID < 300 || ID > 400) && CFLAG:ARG:40 == CFLAG:ARG:41
	IF CFLAG:ARG:1 > 0
		SIF EQUIP:ARG:ID == EQUIP:ARG:(ID - 100)
			SETCOLOR 105,105,105
		PRINTFORML  [91]変身前%ITEMNAME:ID%のカスタマイズをコピー
		PRINTFORML  [92]変身前%ITEMNAME:ID%のカスタマイズにペースト
	ELSE
		SIF EQUIP:ARG:ID == EQUIP:ARG:(ID + 100)
			SETCOLOR 105,105,105
		PRINTFORML  [91]変身後%ITEMNAME:(ID+100)%のカスタマイズをコピー
		PRINTFORML  [92]変身後%ITEMNAME:(ID+100)%のカスタマイズにペースト
	ENDIF
	RESETCOLOR
ENDIF
PRINTL  [99] 돌아간다





;"フレーバー@効果テキスト"
;効果欄が!!で始まっていたら選択不可フラグ
;効果テキストには以下のキーワードを記述可能
;	「軽1」…耐久-5 命中+1	軽6まで可
;	「重1」…耐久+5 命中-1	重6まで可
;
;	「護1」…下着保護+5	護6まで可
;	「晒1」…下着保護-5	晒6まで可
;
@CLOTH_CUSTOMIZE_OPTION_PRINT(now,ARGS:0,ARGS:1,ARGS:2,ARGS:3,ARGS:4,ARGS:5,ARGS:6,ARGS:7,ARGS:8,ARGS:9,ARGS:10)
#dim maxnum,1
#dim now,1
#dim 選択不可フラグ,10
#dims フレーバー,1
#dims 効果テキスト,1

maxnum=8
FOR LOCAL,0,11
	locals'=args:local

	;末尾目印発見時
	IF locals=="@@"
		maxnum=LOCAL-1
		BREAK
	ENDIF




	;圧縮していた스테이터스補正を分割
	replace locals,"^([^@]+)@?.*$","$1"
	フレーバー'=results
	replace locals,"^[^@]*@?(.*)$","$1"
	効果テキスト'=results

	IF strfind(効果テキスト,"!!")==0
		選択不可フラグ:LOCAL=1
		効果テキスト=%substring(効果テキスト,2)%
		SETCOLOR 105,105,105
	ELSE
		選択不可フラグ:LOCAL=0
		IF now == LOCAL
			SETCOLOR 120,250,0
		ELSE
			RESETCOLOR
		ENDIF
	ENDIF

	replace 効果テキスト,"軽1","耐久-5 命中+1 "
	効果テキスト'=results
	replace 効果テキスト,"軽2","耐久-10 命中+2 "
	効果テキスト'=results
	replace 効果テキスト,"軽3","耐久-15 命中+3 "
	効果テキスト'=results
	replace 効果テキスト,"軽4","耐久-20 命中+4 "
	効果テキスト'=results
	replace 効果テキスト,"軽5","耐久-25 命中+5 "
	効果テキスト'=results
	replace 効果テキスト,"軽6","耐久-30 命中+6 "
	効果テキスト'=results

	replace 効果テキスト,"重1","耐久+5 命中-1 "
	効果テキスト'=results
	replace 効果テキスト,"重2","耐久+10 命中-2 "
	効果テキスト'=results
	replace 効果テキスト,"重3","耐久+15 命中-3 "
	効果テキスト'=results
	replace 効果テキスト,"重4","耐久+20 命中-4 "
	効果テキスト'=results
	replace 効果テキスト,"重5","耐久+25 命中-5 "
	効果テキスト'=results
	replace 効果テキスト,"重6","耐久+30 命中-6 "
	効果テキスト'=results

	replace 効果テキスト,"護1","下着保護+5"
	効果テキスト'=results
	replace 効果テキスト,"護2","下着保護+10"
	効果テキスト'=results
	replace 効果テキスト,"護3","下着保護+15"
	効果テキスト'=results
	replace 効果テキスト,"護4","下着保護+20"
	効果テキスト'=results
	replace 効果テキスト,"護5","下着保護+25"
	効果テキスト'=results
	replace 効果テキスト,"護6","下着保護+30"
	効果テキスト'=results

	replace 効果テキスト,"晒1","下着保護-5"
	効果テキスト'=results
	replace 効果テキスト,"晒2","下着保護-10"
	効果テキスト'=results
	replace 効果テキスト,"晒3","下着保護-15"
	効果テキスト'=results
	replace 効果テキスト,"晒4","下着保護-20"
	効果テキスト'=results
	replace 効果テキスト,"晒5","下着保護-25"
	効果テキスト'=results
	replace 効果テキスト,"晒6","下着保護-30"
	効果テキスト'=results



	PRINTFORML  [{LOCAL}]%フレーバー,28,LEFT%%効果テキスト,20,LEFT%
	RESETCOLOR
NEXT

$INPUT_LOOP_0
INPUT
IF RESULT >= 0 && RESULT <= maxnum && 選択不可フラグ:RESULT==0
	RETURN RESULT
ELSE
	CLEARLINE 1
	GOTO INPUT_LOOP_0
ENDIF

RETURN



;↑のインナー版
;	「油1」…油断度　-6～6まで可
@INNER_CUSTOMIZE_OPTION_PRINT(now,ARGS:0,ARGS:1,ARGS:2,ARGS:3,ARGS:4,ARGS:5,ARGS:6,ARGS:7,ARGS:8,ARGS:9,ARGS:10)
#dim maxnum,1
#dim now,1
#dim 選択不可フラグ,10
#dims フレーバー,1
#dims 効果テキスト,1

maxnum=9
FOR LOCAL,0,10
	locals'=args:local

	;末尾目印発見時
	IF locals=="@@"
		maxnum=LOCAL-1
		BREAK
	ENDIF


	SIF now == LOCAL
		SETCOLOR 120,250,0

	;圧縮していた스테이터스補正を分割
	replace locals,"^([^@]+)@?.*$","$1"
	フレーバー'=results
	replace locals,"^[^@]*@?(.*)$","$1"
	効果テキスト'=results

	IF strfind(効果テキスト,"!!")==0
		選択不可フラグ:LOCAL=1
		効果テキスト=%substring(効果テキスト,2)%
		SETCOLOR 105,105,105
	ELSE
		選択不可フラグ:LOCAL=0
	ENDIF

	replace 効果テキスト,"軽1","耐久-5 "
	効果テキスト'=results
	replace 効果テキスト,"軽2","耐久-10 "
	効果テキスト'=results
	replace 効果テキスト,"軽3","耐久-15 "
	効果テキスト'=results
	replace 効果テキスト,"軽4","耐久-20 "
	効果テキスト'=results
	replace 効果テキスト,"軽5","耐久-25 "
	効果テキスト'=results
	replace 効果テキスト,"軽6","耐久-30 "
	効果テキスト'=results

	replace 効果テキスト,"重1","耐久+5 "
	効果テキスト'=results
	replace 効果テキスト,"重2","耐久+10 "
	効果テキスト'=results
	replace 効果テキスト,"重3","耐久+15 "
	効果テキスト'=results
	replace 効果テキスト,"重4","耐久+20 "
	効果テキスト'=results
	replace 効果テキスト,"重5","耐久+25 "
	効果テキスト'=results
	replace 効果テキスト,"重6","耐久+30 "
	効果テキスト'=results

	replace 効果テキスト,"油1","油断度+1 "
	効果テキスト'=results
	replace 効果テキスト,"油2","油断度+2 "
	効果テキスト'=results
	replace 効果テキスト,"油3","油断度+3 "
	効果テキスト'=results
	replace 効果テキスト,"油4","油断度+4 "
	効果テキスト'=results
	replace 効果テキスト,"油5","油断度+5 "
	効果テキスト'=results
	replace 効果テキスト,"油6","油断度+6 "
	効果テキスト'=results
	replace 効果テキスト,"油-1","油断度-1 "
	効果テキスト'=results
	replace 効果テキスト,"油-2","油断度-2 "
	効果テキスト'=results
	replace 効果テキスト,"油-3","油断度-3 "
	効果テキスト'=results
	replace 効果テキスト,"油-4","油断度-4 "
	効果テキスト'=results
	replace 効果テキスト,"油-5","油断度-5 "
	効果テキスト'=results
	replace 効果テキスト,"油-6","油断度-6 "
	効果テキスト'=results

	replace 効果テキスト,"護1","挿入抵抗+5"
	効果テキスト'=results
	replace 効果テキスト,"護2","挿入抵抗+10"
	効果テキスト'=results
	replace 効果テキスト,"護3","挿入抵抗+15"
	効果テキスト'=results
	replace 効果テキスト,"護4","挿入抵抗+20"
	効果テキスト'=results
	replace 効果テキスト,"護5","挿入抵抗+25"
	効果テキスト'=results
	replace 効果テキスト,"護6","挿入抵抗+30"
	効果テキスト'=results

	replace 効果テキスト,"晒1","挿入抵抗-5"
	効果テキスト'=results
	replace 効果テキスト,"晒2","挿入抵抗-10"
	効果テキスト'=results
	replace 効果テキスト,"晒3","挿入抵抗-15"
	効果テキスト'=results
	replace 効果テキスト,"晒4","挿入抵抗-20"
	効果テキスト'=results
	replace 効果テキスト,"晒5","挿入抵抗-25"
	効果テキスト'=results
	replace 効果テキスト,"晒6","挿入抵抗-30"
	効果テキスト'=results



	PRINTFORML  [{LOCAL}]%フレーバー,28,LEFT%%効果テキスト,20,LEFT%
	RESETCOLOR
NEXT

$INPUT_LOOP_0
INPUT
IF RESULT >= 0 && RESULT <= maxnum && 選択不可フラグ:RESULT==0
	RETURN RESULT
ELSE
	CLEARLINE 1
	GOTO INPUT_LOOP_0
ENDIF

RETURN



;カスタマイズ初期化
@CLOTH_CUSTOMIZE_OPTION_INITIALIZE(num,id,refcustom)
#DIM num,1
#DIM id,1
#DIM ref refcustom,0

EQUIP:num:id=0
SIF CFLAG:num:1 > 0
	CFLAG:num:(900 + id) = 0
VARSET refcustom


;カスタムコピー
@CLOTH_CUSTOMIZE_OPTION_COPY91(ARG,id,CUSTOM_NUM,refCUSTOM)
#DIM id,1
#DIM CUSTOM_NUM,1
#DIM ref refCUSTOM,0
	IF CFLAG:ARG:1 > 0
		REPEAT CUSTOM_NUM
			refCUSTOM:COUNT = FIGURE_SPLIT(EQUIP:ARG:(ID - 100), COUNT + 1)
		REND
		PRINTFORMW 変身前%ITEMNAME:ID%のカスタマイズをコピーしました
	ELSE
		REPEAT CUSTOM_NUM
			refCUSTOM:COUNT = FIGURE_SPLIT(EQUIP:ARG:(ID + 100), COUNT + 1)
		REND
		PRINTFORMW 変身後%ITEMNAME:(ID+100)%のカスタマイズをコピーしました
	ENDIF

;カスタムペースト
@CLOTH_CUSTOMIZE_OPTION_COPY92(ARG,ID)
#DIM ID,1
IF CFLAG:ARG:1 > 0
	EQUIP:ARG:(ID - 100) = EQUIP:ARG:ID
	PRINTFORMW 変身前%ITEMNAME:ID%のカスタマイズにペーストしました
ELSE
	EQUIP:ARG:(ID + 100) = EQUIP:ARG:ID
	PRINTFORMW 変身後%ITEMNAME:(ID+100)%のカスタマイズにペーストしました
ENDIF

;オプション記録
@CLOTH_CUSTOMIZE_OPTION_SAVE(ARG,ID,CUSTOM_NUM,refCUSTOM)
#DIM ID,1
#DIM CUSTOM_NUM,1
#DIM REF refCUSTOM,0
LOCAL = 0
REPEAT CUSTOM_NUM
	SIF COUNT == 0
		CONTINUE
	LOCAL += refCUSTOM:COUNT * POWER(10, COUNT)
REND
LOCAL += refCUSTOM:0
EQUIP:ARG:ID = LOCAL
