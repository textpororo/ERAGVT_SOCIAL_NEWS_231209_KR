;--------------------------------------------------
;보스 촉수・최종 보스 촉수 섬멸 상황 확인
;ローカル変数LOCAL:0はチェック用
;LOCAL:1は生き残っている촉수 총 마릿수が入る
@TENTACLE_SURVIVE, ARGS
LOCAL:0 = 1
LOCAL:1 = 0
LOCAL:2 = 0
LOCAL:3 = 0
;보스残存or雑魚戦
IF ENEMY_TYPE_CHECK_F("BOSS") == 1 || ENEMY_TYPE_CHECK_F("MOB") == 1
	FOR LOCAL:2, 0, FLAG:3
		CALL TENTACLE_SURVIVE_CHECK, LOCAL:0
		IF RESULT > 0
			SELECTCASE ARGS
				CASE "NAME"
					CALL TENTACLE_ACCESS, "NAME"
				CASE "NUM"
					LOCAL:1 += 1
			ENDSELECT
		ENDIF
		LOCAL:0 *= 2
	NEXT

	;返す値の選定
	SELECTCASE ARGS
		CASE "NUM"
			RETURN LOCAL:1
	ENDSELECT
;최종 보스のみ
ELSE
	FOR LOCAL:2, 0, FLAG:4
		CALL TENTACLE_SURVIVE_CHECK, LOCAL:0
		IF RESULT > 0
			SELECTCASE ARGS
				CASE "NAME"
					CALL TENTACLE_ACCESS, "NAME"
				CASE "NUM"
					LOCAL:1 += 1
			ENDSELECT
		ENDIF
		LOCAL:0 *= 2
	NEXT

	;返す値の選定
	SELECTCASE ARGS
		CASE "NUM"
			RETURN LOCAL:1
	ENDSELECT
ENDIF

;--------------------------------------------------
;ビット値を투척て生きている보스 촉수・최종 보스 촉수の番号を返す
;BOSSx.ERBの番号を返す
@TENTACLE_SURVIVE_CHECK, ARG
;보스残存or雑魚戦
IF FLAG:100 > 0 || ENEMY_TYPE_CHECK_F("MOB") == 1
	IF FLAG:100 & ARG
		;Ｃ촉수
		IF ARG == 1
			RETURN 1
		;V촉수
		ELSEIF ARG == 2
			RETURN 2
		;A촉수
		ELSEIF ARG == 4
			RETURN 3
		;B촉수
		ELSEIF ARG == 8
			RETURN 4
		;S촉수
		ELSEIF ARG == 16
			RETURN 5
		;P촉수
		ELSEIF ARG == 32
			RETURN 6
		;H촉수
		ELSEIF ARG == 64
			RETURN 7
		;０か負の値
		ELSEIF ARG <= 0
			PRINTL 
			PRINTL #####     ERROR !!     #####
			PRINTL @TENTACLE_SURVIVE_CHECKにて
			PRINTFORML 参照しようとしている보스IDが０か負の値（ARG = {ARG}）になっています。原因究明のため、
			PRINTL 掲示板にできるだけ詳細な発生状況を報告してください
			PRINTW 
		ELSE
			PRINTL 
			PRINTL #####     ERROR !!     #####
			PRINTL @TENTACLE_SURVIVE_CHECKにて
			PRINTFORML 参照しようとしている보스IDが範囲外（ARG = {ARG}）になっています。原因究明のため、
			PRINTL 掲示板にできるだけ詳細な発生状況を報告してください
			PRINTW 
		ENDIF
	ENDIF
;生存보스＝최종 보스のみ
ELSE
	IF FLAG:101 & ARG
		;K촉수
		IF ARG == 1
			RETURN 1
		;천사の樹
		ELSEIF ARG == 2
			RETURN 2
		;０か負の値
		ELSEIF ARG <= 0
			PRINTL 
			PRINTL #####     ERROR !!     #####
			PRINTL @TENTACLE_SURVIVE_CHECKにて
			PRINTFORML 参照しようとしている최종 보스IDが０か負の値（ARG = {ARG}）になっています。原因究明のため、
			PRINTL 掲示板にできるだけ詳細な発生状況を報告してください
			PRINTW 
		ELSE
			PRINTL 
			PRINTL #####     ERROR !!     #####
			PRINTL @TENTACLE_SURVIVE_CHECKにて
			PRINTFORML 参照しようとしている최종 보스IDが範囲外（ARG = {ARG}）になっています。原因究明のため、
			PRINTL 掲示板にできるだけ詳細な発生状況を報告してください
			PRINTW 
		ENDIF
	ENDIF
ENDIF

;--------------------------------------------------
;BOSSx.ERBの番号を元に보스 촉수・최종 보스 촉수のビット値を返す
;上の関数の逆版
@TENTACLE_BITVALUE, ARG
;보스or雑魚
IF ENEMY_TYPE_CHECK_F("BOSS") == 1 || ENEMY_TYPE_CHECK_F("MOB") == 1
	;Ｃ촉수
	IF ARG == 1
		RETURN 1
	;V촉수
	ELSEIF ARG == 2
		RETURN 2
	;A촉수
	ELSEIF ARG == 3
		RETURN 4
	;B촉수
	ELSEIF ARG == 4
		RETURN 8
	;S촉수
	ELSEIF ARG == 5
		RETURN 16
	;P촉수
	ELSEIF ARG == 6
		RETURN 32
	;H촉수
	ELSEIF ARG == 7
		RETURN 64
	;０か負の値
	ELSEIF ARG <= 0
		PRINTL 
		PRINTL #####     ERROR !!     #####
		PRINTL @TENTACLE_BITVALUEにて
		PRINTFORML 参照しようとしている보스IDが０か負の値（ARG = {ARG}）になっています。原因究明のため、
		PRINTL 掲示板にできるだけ詳細な発生状況を報告してください
		PRINTW 
	ELSE
		PRINTL 
		PRINTL #####     ERROR !!     #####
		PRINTL @TENTACLE_BITVALUEにて
		PRINTFORML 参照しようとしている보스IDが範囲外（ARG = {ARG}）になっています。原因究明のため、
		PRINTL 掲示板にできるだけ詳細な発生状況を報告してください
		PRINTW 
	ENDIF
;최종 보스
ELSE
	;K촉수
	IF ARG == 1
		RETURN 1
	;천사の樹
	ELSEIF ARG == 2
		RETURN 2
	;０か負の値
	ELSEIF ARG <= 0
		PRINTL 
		PRINTL #####     ERROR !!     #####
		PRINTL @TENTACLE_BITVALUEにて
		PRINTFORML 参照しようとしている최종 보스IDが０か負の値（ARG = {ARG}）になっています。原因究明のため、
		PRINTL 掲示板にできるだけ詳細な発生状況を報告してください
		PRINTW 
	ELSE
		PRINTL 
		PRINTL #####     ERROR !!     #####
		PRINTL @TENTACLE_BITVALUEにて
		PRINTFORML 参照しようとしている최종 보스IDが範囲外（ARG = {ARG}）になっています。原因究明のため、
		PRINTL 掲示板にできるだけ詳細な発生状況を報告してください
		PRINTW 
	ENDIF
ENDIF

;--------------------------------------------------
;촉수のファイルにアクセス（戦闘用）
;FLAG:10の値でアクセス先が보스 촉수か최종 보스 촉수か判定する
;パッチ1 幼体とか雑魚촉수生成用　置換BOSS→%SAVESTR:13%
@TENTACLE_ACCESS, ARGS

;보스またはザコ
RESULTS'="【エラー："+SAVESTR:13+"_"+TOSTR(FLAG:11)+"'"+ARGS+"'のTENTACLE_ACCESS関数失敗】"
IF GET_LASTBOSS_PHASE_F() == 0 || ENEMY_TYPE_CHECK_F("MOB") == 1
	SELECTCASE ARGS
		CASE "NAME"
			CALL TENTACLE_ACCESS, "GETNAME"
			PRINTFORM %RESULTS%
		CASE "GETNAME"
			TRYCALLFORM TENTACLE_%SAVESTR:13%_{FLAG:11}_GETNAME
		CASE "HP"
			TRYCALLFORM TENTACLE_%SAVESTR:13%_{FLAG:11}_HP
			RETURN RESULT
		CASE "SYASEI"
			TRYCALLFORM TENTACLE_%SAVESTR:13%_{FLAG:11}_SYASEI
			RETURN RESULT
		CASE "SAKUSEI"
			TRYCALLFORM TENTACLE_%SAVESTR:13%_{FLAG:11}_SAKUSEI
			RETURN RESULT
		CASE "YUDAN"
			TRYCALLFORM TENTACLE_%SAVESTR:13%_{FLAG:11}_YUDAN
			RETURN RESULT
		CASE "KOUGEKI"
			TRYCALLFORM TENTACLE_%SAVESTR:13%_{FLAG:11}_KOUGEKI
			RETURN RESULT
		CASE "BOUGYO"
			TRYCALLFORM TENTACLE_%SAVESTR:13%_{FLAG:11}_BOUGYO
			RETURN RESULT
		CASE "BINSYOU"
			TRYCALLFORM TENTACLE_%SAVESTR:13%_{FLAG:11}_BINSYOU
			RETURN RESULT
		CASE "CHISEI"
			TRYCALLFORM TENTACLE_%SAVESTR:13%_{FLAG:11}_CHISEI
			RETURN RESULT
		CASE "SHORT"
			TRYCALLFORM TENTACLE_%SAVESTR:13%_{FLAG:11}_SHORT
			RETURN RESULT
		CASE "MIDDLE"
			TRYCALLFORM TENTACLE_%SAVESTR:13%_{FLAG:11}_MIDDLE
			RETURN RESULT
		CASE "LONG"
			TRYCALLFORM TENTACLE_%SAVESTR:13%_{FLAG:11}_LONG
			RETURN RESULT
		CASE "HOLD"
			TRYCALLFORM TENTACLE_%SAVESTR:13%_{FLAG:11}_HOLD
			RETURN RESULT
		CASE "ATTACK_ROUTINE"
			TRYCALLFORM TENTACLE_%SAVESTR:13%_{FLAG:11}_ATTACK_ROUTINE
			RETURN RESULT
		CASE "SEX_ROUTINE"
			TRYCALLFORM TENTACLE_%SAVESTR:13%_{FLAG:11}_SEX_ROUTINE
			RETURN RESULT
		CASE "PALAM_HOSEI"
			TRYCALLFORM TENTACLE_%SAVESTR:13%_{FLAG:11}_PALAM_HOSEI
			RETURN RESULT:0, RESULT:1, RESULT:2, RESULT:3, RESULT:4, RESULT:5, RESULT:6, RESULT:7, RESULT:8, RESULT:9, RESULT:10, RESULT:11
	ENDSELECT
;최종 보스
ELSE
	SELECTCASE ARGS
		CASE "NAME"
			CALL TENTACLE_ACCESS, "GETNAME"
			PRINTFORM %RESULTS%
		CASE "GETNAME"
			TRYCALLFORM TENTACLE_LASTBOSS_{FLAG:11}_GETNAME
		CASE "HP"
			TRYCALLFORM TENTACLE_LASTBOSS_{FLAG:11}_HP
			RETURN RESULT
		CASE "SYASEI"
			TRYCALLFORM TENTACLE_LASTBOSS_{FLAG:11}_SYASEI
			RETURN RESULT
		CASE "SAKUSEI"
			TRYCALLFORM TENTACLE_LASTBOSS_{FLAG:11}_SAKUSEI
			RETURN RESULT
		CASE "YUDAN"
			TRYCALLFORM TENTACLE_LASTBOSS_{FLAG:11}_YUDAN
			RETURN RESULT
		CASE "KOUGEKI"
			TRYCALLFORM TENTACLE_LASTBOSS_{FLAG:11}_KOUGEKI
			RETURN RESULT
		CASE "BOUGYO"
			TRYCALLFORM TENTACLE_LASTBOSS_{FLAG:11}_BOUGYO
			RETURN RESULT
		CASE "BINSYOU"
			TRYCALLFORM TENTACLE_LASTBOSS_{FLAG:11}_BINSYOU
			RETURN RESULT
		CASE "CHISEI"
			TRYCALLFORM TENTACLE_LASTBOSS_{FLAG:11}_CHISEI
			RETURN RESULT
		CASE "SHORT"
			TRYCALLFORM TENTACLE_LASTBOSS_{FLAG:11}_SHORT
			RETURN RESULT
		CASE "MIDDLE"
			TRYCALLFORM TENTACLE_LASTBOSS_{FLAG:11}_MIDDLE
			RETURN RESULT
		CASE "LONG"
			TRYCALLFORM TENTACLE_LASTBOSS_{FLAG:11}_LONG
			RETURN RESULT
		CASE "HOLD"
			TRYCALLFORM TENTACLE_LASTBOSS_{FLAG:11}_HOLD
			RETURN RESULT
		CASE "ATTACK_ROUTINE"
			TRYCALLFORM TENTACLE_LASTBOSS_{FLAG:11}_ATTACK_ROUTINE
			RETURN RESULT
		CASE "SEX_ROUTINE"
			TRYCALLFORM TENTACLE_LASTBOSS_{FLAG:11}_SEX_ROUTINE
			RETURN RESULT
		CASE "PALAM_HOSEI"
			TRYCALLFORM TENTACLE_LASTBOSS_{FLAG:11}_PALAM_HOSEI
			RETURN RESULT:0, RESULT:1, RESULT:2, RESULT:3, RESULT:4, RESULT:5, RESULT:6, RESULT:7, RESULT:8, RESULT:9, RESULT:10, RESULT:11
	ENDSELECT
ENDIF

;--------------------------------------------------
;촉수のファイルにアクセス（幽閉用）
;CFLAG:20の値でアクセス先が보스 촉수か최종 보스 촉수か判定する
@TENTACLE_ACCESS_PRISON, ARG, ARGS
IF CFLAG:ARG:20 == 0
	SELECTCASE ARGS
		CASE "NAME"
			CALL TENTACLE_ACCESS_PRISON, ARG, "GETNAME"
			PRINTFORM %RESULTS%
		CASE "GETNAME"
			TRYCALLFORM TENTACLE_BOSS_{CFLAG:ARG:21}_GETNAME
		CASE "PRISON_ROUTINE"
			TRYCALLFORM TENTACLE_BOSS_{CFLAG:ARG:21}_PRISON_ROUTINE
			RETURN RESULT
		CASE "PALAM_HOSEI"
			TRYCALLFORM TENTACLE_BOSS_{CFLAG:ARG:21}_PALAM_HOSEI
			RETURN RESULT:0, RESULT:1, RESULT:2, RESULT:3, RESULT:4, RESULT:5, RESULT:6, RESULT:7, RESULT:8, RESULT:9, RESULT:10, RESULT:11
	ENDSELECT
ELSEIF CFLAG:ARG:20 == 1
	SELECTCASE ARGS
		CASE "NAME"
			CALL TENTACLE_ACCESS_PRISON, ARG, "GETNAME"
			PRINTFORM %RESULTS%
		CASE "GETNAME"
			TRYCALLFORM TENTACLE_LASTBOSS_{CFLAG:ARG:21}_GETNAME
		CASE "PRISON_ROUTINE"
			TRYCALLFORM TENTACLE_LASTBOSS_{CFLAG:ARG:21}_PRISON_ROUTINE
			RETURN RESULT
		CASE "PALAM_HOSEI"
			TRYCALLFORM TENTACLE_BOSS_{CFLAG:ARG:21}_PALAM_HOSEI
			RETURN RESULT:0, RESULT:1, RESULT:2, RESULT:3, RESULT:4, RESULT:5, RESULT:6, RESULT:7, RESULT:8, RESULT:9, RESULT:10, RESULT:11
	ENDSELECT
ENDIF

;--------------------------------------------------
;보스 촉수・최종 보스 촉수の補正
;式 ((Lv * 10 + 95) * BASE) /100 + BONUS
@TENTACLE_STATUS_HOSEI, ARG,ARG:1 = 100
CALL TENTACLE_LEVEL
LOCAL:0 = RESULT * 10
LOCAL:2 = ((LOCAL:0 + 95) * ARG) / 100 + ARG:1
RETURN LOCAL:2

;--------------------------------------------------
;보스 촉수・최종 보스 촉수の레벨
@TENTACLE_LEVEL
#DIM 撃破数
#DIM 基礎레벨
#DIM 日数레벨

;撃破数
CALL TENTACLE_SURVIVE, "NUM"
撃破数 = FLAG:3 - RESULT
;撃破した촉수の数に応じて基礎레벨上昇
LOCAL = 3
SIF GAME_OPTION_CHECK_F(OPTION_hardcore)
	LOCAL += 2
SIF GAME_OPTION_CHECK_F(OPTION_solo)
	LOCAL += 1
SIF GAME_OPTION_CHECK_F(OPTION_endless)
	LOCAL -= 1
SIF GAME_OPTION_CHECK_F(OPTION_가입은퇴있음)
	LOCAL -= 1
SIF GAME_OPTION_CHECK_F(OPTION_스탯저하있음)
	LOCAL -= 1
SIF LOCAL < -4
	LOCAL = -4

基礎레벨 = 撃破数 * LOCAL + 4
;ザコ敵なら3/4
SIF ENEMY_TYPE_CHECK_F("MOB") == 1
	基礎레벨 = 基礎레벨 * 3 / 4

;日数経過による레벨アップ
;(経過日数/一体あたり制限時間)*1.5　が上昇基準値
LOCAL = 150
;※エンドレスは普通より緩やかな上昇
SIF GAME_OPTION_CHECK_F(OPTION_endless)
	LOCAL = LOCAL/3
;※ハードコアは普通より急な上昇
SIF GAME_OPTION_CHECK_F(OPTION_hardcore)
	LOCAL = LOCAL*4/3
;インスタントも緩やか
SIF GAME_OPTION_CHECK_F(OPTION_스탯저하있음)
	LOCAL = LOCAL*2/3
SIF GAME_OPTION_CHECK_F(OPTION_가입은퇴있음)
	LOCAL = LOCAL/2

SIF LOCAL < 0
	LOCAL = 0

日数레벨 = LOCAL * DAY / FLAG:2 / 100

;計算結果
LOCAL = 基礎레벨 + 日数레벨
RETURN LOCAL



;--------------------------------------------------
;보스 촉수のERBの数を返す
;今はまだ１００種類までしか作れないので注意
@GET_BOSS_ERB_NUM
VARSET LOCAL
LOCAL = 1
WHILE LOCAL:1 == 0
	TRYCCALLFORM TENTACLE_BOSS_{LOCAL}
		LOCAL += 1
	CATCH
		LOCAL:1 = 1
	ENDCATCH
WEND
RETURN LOCAL - 1

;--------------------------------------------------
;최종 보스 촉수のERBの数を返す
;今はまだ１００種類までしか作れないので注意
@GET_LASTBOSS_ERB_NUM
VARSET LOCAL
LOCAL = 1
WHILE LOCAL:1 == 0
	TRYCCALLFORM TENTACLE_LASTBOSS_{LOCAL}
		LOCAL += 1
	CATCH
		LOCAL:1 = 1
	ENDCATCH
WEND
RETURN LOCAL - 1





;--------------------------------------------------
;보스撃破時のフラグ処理関係
@AFTER_KILLED_BOSS
;ターン終了まで보스出現を抑制
FLAG:49 = 1
CALL RESEARCH_QUOTA


;--------------------------------------------------
;探索ノルマ
;보스の레벨と同様の算出方法
@RESEARCH_QUOTA
#DIM LCOUNT
#DIM 撃破数
#DIM 討伐補正
#DIM 日数補正
CALL TENTACLE_SURVIVE, "NUM"
撃破数 = MIN(FLAG:3 - RESULT + 1, 9)
;撃破した촉수の数に応じてノルマ増加
LOCAL = 12
SIF GAME_OPTION_CHECK_F(OPTION_hardcore)
	LOCAL += 6
SIF GAME_OPTION_CHECK_F(OPTION_solo)
	LOCAL -= 6
SIF GAME_OPTION_CHECK_F(OPTION_가입은퇴있음)
	LOCAL += 1
SIF GAME_OPTION_CHECK_F(OPTION_스탯저하있음)
	LOCAL -= 1

;計算開始
討伐補正 = 撃破数 * LOCAL / 3 + 24
SIF GAME_OPTION_CHECK_F(OPTION_제한시간없음)
	討伐補正 /= 2
SIF GAME_OPTION_CHECK_F(OPTION_solo)
	討伐補正 -= 12

;日数経過による補正をかける
LOCAL = 2
SIF GAME_OPTION_CHECK_F(OPTION_제한시간없음)
	LOCAL -= 4
SIF GAME_OPTION_CHECK_F(OPTION_hardcore)
	LOCAL += 1

日数補正 = SQRT(DAY) * LOCAL


LOCAL = 討伐補正 + 日数補正
SIF LOCAL < 10
	LOCAL = 10
IF GAME_OPTION_CHECK_F(OPTION_solo) && LOCAL >= 60 + RAND:5
	LOCAL = 60
ELSEIF LOCAL >= 90 + RAND:5
	LOCAL = 90
ENDIF
SIF GET_LASTBOSS_PHASE_F() >= 1
	LOCAL = LOCAL * 6 / 5

FLAG:46 = LOCAL
FLAG:47 = 0


;--------------------------------------------------
;雑魚撃破ノルマ
;보스の레벨と同様の算出方法
@MOB_KILL_QUOTA
#DIM 撃破数
#DIM 討伐補正
#DIM 日数補正

CALL TENTACLE_SURVIVE, "NUM"
撃破数 = MIN(FLAG:3 - RESULT + 1, 9)
;撃破した촉수の数に応じてノルマ増加
LOCAL = 2
SIF GAME_OPTION_CHECK_F(OPTION_hardcore)
	LOCAL += 1
SIF GAME_OPTION_CHECK_F(OPTION_solo)
	LOCAL -= 1
SIF GAME_OPTION_CHECK_F(OPTION_스탯저하있음)
	LOCAL -= 1

討伐補正 = 撃破数 * LOCAL / 3 + 2

;日数経過による補正をかける
LOCAL = 150
SIF GAME_OPTION_CHECK_F(OPTION_hardcore)
	LOCAL = LOCAL*4/3
SIF GAME_OPTION_CHECK_F(OPTION_가입은퇴있음)
	LOCAL = LOCAL*2/3

SIF LOCAL < 0
	LOCAL = 0

日数補正 = LOCAL * DAY / FLAG:2 / 100


LOCAL = 討伐補正 + 日数補正
SIF GET_LASTBOSS_PHASE_F() >= 1
	LOCAL /= 2
SIF GAME_OPTION_CHECK_F(OPTION_solo) && LOCAL >= 8 + RAND:5
	LOCAL = 8
SIF LOCAL >= 15 + RAND:5
	LOCAL = 15

RETURN LOCAL



