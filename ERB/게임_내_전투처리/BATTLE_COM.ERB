;戦闘コマンドの表示と処理

;コマンド表示
@SHOW_USERCOM
RESETCOLOR
PRINTL 
;カテゴリ分けする場合
IF CONFIG_CHECK_SCREEN_F(2) > 0
	PRINTFORML 　┌──────\@TCVARn:8 == 0 ? ─ # ┬ \@─────────────────────────────────────┐
	PRINTPLAIN 　│
	PRINT  [810] 特殊 
	;特殊コマンド選択中(拘束時)
	IF TCVARn:8 == 0 && TCVARn:0 == 0
		TCVARn:8 += 10
		PRINTPLAIN 　
		CALL PRINT_COMNAME, 44
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 45
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 46
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┐
		CALL PRINT_COMNAME, 72
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 73
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 47
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [820] 性技 
		ELSE
			PRINT  [820] 공격 
		ENDIF
		PRINTPLAIN │
		CALL PRINT_COMNAME, 69
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 99
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┤
		CALL PRINT_COMNAME, 70
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 71
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 72
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [830] 拘束 
		ELSE
			PRINT  [830] 補助 
		ENDIF
		PRINTPLAIN │
		TCVARn:8 -= 10
	;特殊コマンド選択中
	ELSEIF TCVARn:8 == 0
		TCVARn:8 += 10
		PRINTPLAIN 　
		RESULT = 0
		TRYCALLFORM COM_ABLE{0}
		IF RESULT
			;距離指定変身
			TRYCALLFORM COM_ABLE{201}
			IF RESULT
				CALL PRINT_COMNAME, 201
				PRINTPLAIN 　 
				CALL PRINT_COMNAME, 202
				PRINTPLAIN 　 
				CALL PRINT_COMNAME, 203
			;通常変身
			ELSE
				CALL PRINT_COMNAME, 0
			ENDIF
		ELSE
			;SP変身
			TRYCALLFORM COM_ABLE{11}
			SIF RESULT
				CALL PRINT_COMNAME, 11
		ENDIF
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┐
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [820] 性技 
		ELSE
			PRINT  [820] 공격 
		ENDIF
		PRINTPLAIN │
		CALL PRINT_COMNAME, 16
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 17
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 99
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┤
		CALL PRINT_COMNAME, 69
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 71
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 72
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [830] 拘束 
		ELSE
			PRINT  [830] 補助 
		ENDIF
		PRINTPLAIN │
		TCVARn:8 -= 10
	;性技コマンド選択中(＝拘束時)
	ELSEIF  TCVARn:8 == 1 && TCVARn:0 == 0
		TCVARn:8 += 10
		PRINTPLAIN │
		CALL PRINT_COMNAME, 100
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 101
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 102
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┘
		CALL PRINT_COMNAME, 103
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 104
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [820] 性技 
		ELSE
			PRINT  [820] 공격 
		ENDIF
		PRINTPLAIN 　
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┐
		CALL PRINT_COMNAME, 70
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 71
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 72
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [830] 拘束 
		ELSE
			PRINT  [830] 補助 
		ENDIF
		PRINTPLAIN │
		TCVARn:8 -= 10
	;공격コマンド選択中
	ELSEIF  TCVARn:8 == 1
		TCVARn:8 += 10
		PRINTPLAIN │
		CALL PRINT_COMNAME, 1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 2
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 3
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┘
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [820] 性技 
		ELSE
			PRINT  [820] 공격 
		ENDIF
		PRINTPLAIN 　
		CALL PRINT_COMNAME, 16
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 17
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┐
		CALL PRINT_COMNAME, 74
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 71
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 72
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [830] 拘束 
		ELSE
			PRINT  [830] 補助 
		ENDIF
		PRINTPLAIN │
		TCVARn:8 -= 10
	;補助コマンド選択中(拘束時)
	ELSEIF  TCVARn:8 == 2 && TCVARn:0 == 0
		TCVARn:8 += 10
		PRINTPLAIN │
		IF (TCVARn:12 & 강구속)
			CALL PRINT_COMNAME, 40
		ELSE
			CALL PRINT_COMNAME, 8
		ENDIF
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 9
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 10
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┤
		CALL PRINT_COMNAME, 11
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 12
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 13
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [820] 性技 
		ELSE
			PRINT  [820] 공격 
		ENDIF
		PRINTPLAIN │
		CALL PRINT_COMNAME, 14
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 15
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┘
		CALL PRINT_COMNAME, 70
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 71
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 72
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [830] 拘束 
		ELSE
			PRINT  [830] 補助 
		ENDIF
		PRINTPLAIN 　
		TCVARn:8 -= 10
	;補助コマンド選択中
	ELSEIF  TCVARn:8 == 2
		TCVARn:8 += 10
		PRINTPLAIN │
		CALL PRINT_COMNAME, 6
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 7
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 5
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┤
		CALL PRINT_COMNAME, 4
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [820] 性技 
		ELSE
			PRINT  [820] 공격 
		ENDIF
		PRINTPLAIN │
		CALL PRINT_COMNAME, 16
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 17
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┘
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 71
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 72
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [830] 拘束 
		ELSE
			PRINT  [830] 補助 
		ENDIF
		PRINTPLAIN 　
		TCVARn:8 -= 10
	ENDIF
	PRINTPLAIN 　　　　　　　　　　　　　　
	PRINT 스테이터스 표시[800]
	PRINTPLAIN  　　　　　　　 
	LOCALS = 
	SIF CHECK_CAN_RETREAT_F() == 0
		SETCOLOR 128,128,128
	SIF (TCVARn:0 > 0 && GETBATTLESITUATION("撤退不可") == 0 && (TCVARn:12 & 기절) == 0) || FLAG:999 == 1
		LOCALS = 撤退[999]

	PRINTFORM %LOCALS, 9%
	RESETCOLOR
	PRINTPLAIN 　│
	PRINTL 
	PRINTFORML 　└──────\@TCVARn:8 == 2 ? ─ # ┴ \@─────────────────────────────────────┘
;纏めて表示する場合
ELSE
	TCVARn:8 += 10
	;拘束されている最中のコマンド
	IF TCVARn:0 == 0
		CALL PRINT_COMNAME, 11
		PRINTL 
		PRINTL 
		IF (TCVARn:12 & 강구속)
			CALL PRINT_COMNAME, 40
		ELSE
			CALL PRINT_COMNAME, 8
		ENDIF
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 9
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 10
		PRINTPLAIN 　 
		PRINTL 

		CALL PRINT_COMNAME, 12
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 13
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 14
		PRINTPLAIN 　 
		PRINTL 

		RESULT = 0
		FOR LOCAL,44,47
			TRYCALLFORM COM_ABLE{LOCAL}
			IF RESULT
				CALL PRINT_COMNAME, LOCAL
				PRINTPLAIN 　 
			ENDIF
		NEXT
		PRINTL

		CALL PRINT_COMNAME, 70
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 71
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 72
		PRINTPLAIN 　
		PRINTL 

		CALL PRINT_COMNAME, 100
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 101
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 102
		PRINTL 

		CALL PRINT_COMNAME, 103
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 104
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTL 

		CALL PRINT_COMNAME, 15
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTL 

	;通常時のコマンド
	ELSE
		RESULT = 0
		TRYCALLFORM COM_ABLE{0}
		;変身コマンドが表示される状態
		IF RESULT
			;距離指定変身
			TRYCALLFORM COM_ABLE{201}
			IF RESULT

				CALL FORECAST_OUTPUT_SETCOLOR(TCVARn:30,"COM")
				PRINTFORM %"《危険度:"+(TCVARn:30>=0 ? TOSTR(TCVARn:30) # "??")+"%》", 22%
				PRINTPLAIN 　 
				CALL FORECAST_OUTPUT_SETCOLOR(TCVARn:31,"COM")
				PRINTFORM %"《危険度:"+(TCVARn:31>=0 ? TOSTR(TCVARn:31) # "??")+"%》", 22%
				PRINTPLAIN 　 
				CALL FORECAST_OUTPUT_SETCOLOR(TCVARn:32,"COM")
				PRINTFORM %"《危険度:"+(TCVARn:32>=0 ? TOSTR(TCVARn:32) # "??")+"%》", 22%
				RESETCOLOR
				PRINTL
				CALL PRINT_COMNAME, 201
				PRINTPLAIN 　 
				CALL PRINT_COMNAME, 202
				PRINTPLAIN 　 
				CALL PRINT_COMNAME, 203
				PRINTL
				PRINTFORM 　　　         ----------------------------------------------


			;通常変身
			ELSE
				CALL PRINT_COMNAME, 0
			ENDIF
			PRINTL
		;変身コマンドが表示されない状態(通常変身済みor変身不可)
		ELSE
			;가만히있는다
			TRYCALLFORM COM_ABLE{11}
			IF RESULT
				CALL PRINT_COMNAME, 11
				PRINTL
			ELSE

				CALL FORECAST_OUTPUT_SETCOLOR(TCVARn:30,"COM")
				PRINTFORM %"《危険度:"+(TCVARn:30>=0 ? TOSTR(TCVARn:30) # "??")+"%》", 22%
				PRINTPLAIN 　 
				CALL FORECAST_OUTPUT_SETCOLOR(TCVARn:31,"COM")
				PRINTFORM %"《危険度:"+(TCVARn:31>=0 ? TOSTR(TCVARn:31) # "??")+"%》", 22%
				PRINTPLAIN 　 
				CALL FORECAST_OUTPUT_SETCOLOR(TCVARn:32,"COM")
				PRINTFORM %"《危険度:"+(TCVARn:32>=0 ? TOSTR(TCVARn:32) # "??")+"%》", 22%
				RESETCOLOR
				PRINTL

			ENDIF
		ENDIF

		CALL PRINT_COMNAME, 1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 2
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 3
		PRINTL

		CALL PRINT_COMNAME, 6
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 7
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 5
		PRINTL
		;↑ここまで距離依存コマンド
		PRINTL

		CALL PRINT_COMNAME, 4
		PRINTPLAIN 　 
		CALL FORECAST_OUTPUT_SETCOLOR(TCVARn:33,"COM")
		CALL PRINT_COMNAME, 16
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 17
		PRINTL 

		TRYCALLFORM COM_ABLE{73}
		;SP変身
		IF RESULT
			CALL PRINT_COMNAME, 73
		;SPバースト
		ELSE
			CALL PRINT_COMNAME, 70
		ENDIF

		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 71
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 72
		PRINTL 

		CALL PRINT_COMNAME, 74
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		TRYCALLFORM COM_ABLE{69}
		IF RESULT
			CALL PRINT_COMNAME, 69
		ENDIF
		PRINTL 
		PRINTL 
		PRINTL 
		

	ENDIF

	TCVARn:8 -= 10

	PRINT 　 스테이터스 표시[800]

	SIF CHECK_CAN_RETREAT_F() == 0
		SETCOLOR 128,128,128
	SIF (TCVARn:0 > 0 && GETBATTLESITUATION("撤退不可") == 0 && (TCVARn:12 & 기절) == 0) || FLAG:999 == 1
		PRINT 　　　　　　　　撤退[999]
	RESETCOLOR

	TCVARn:8 += 10
	PRINTPLAIN 　 
	CALL PRINT_COMNAME, 99
	TCVARn:8 -= 10
ENDIF


;コマンド処理
@USERCOM
IF RESULT == 999 && ((TCVARn:0 > 0 && GETBATTLESITUATION("撤退不可") == 0 && (TCVARn:12 & 기절) == 0) || FLAG:999 == 1)
	IF CHECK_CAN_RETREAT_F()
		PRINTL 
		FONTBOLD
		SETCOLOR 0, 255, 150
		PRINTL ********** 自分の行動 **********
		RESETCOLOR
		FONTREGULAR
		PRINTL 

		;撤退
		IF ENEMY_TYPE_CHECK_F("AKUOTI") == 0
			CALL ACT_HANTEI_TETTAI_TENTACLE
			IF RESULT == 1
				;지문: 撤退成功
				CALL MESSAGE_BATTLE_CHARA_TETTAI_SUCCESS
				;지문: 세뇌/흑화 캐릭터가 操作キャラに撤退されてしまった
				SIF ENEMY_TYPE_CHECK_F("AKUOTI") == 1
					CALL MESSAGE_OTHER_BATTLE_CHARA_TETTAI_SUCCESS

				TRYCALL KYUSHUTU_SUCCESS_HANTEI
				;최종 보스強化
				;TRYCALLFORM LASTBOSS_KYOUKA_{FLAG:11}_BATTLEEND,0
				BEGIN AFTERTRAIN
			ELSE
				;지문: 撤退失敗
				CALL MESSAGE_BATTLE_CHARA_TETTAI_FALSE
				;지문: 세뇌/흑화 캐릭터가 操作キャラの撤退を防いだ
				SIF ENEMY_TYPE_CHECK_F("AKUOTI") == 1
					CALL MESSAGE_OTHER_BATTLE_CHARA_TETTAI_FALSE
				JUMP SOURCE_CHECK
			ENDIF
		ELSE
			CALL ACT_HANTEI_TETTAI_TENTACLE
			IF RESULT == 1
				;지문: 撤退成功
				CALL MESSAGE_BATTLE_CHARA_TETTAI_SUCCESS
				;지문: 세뇌/흑화 캐릭터가 操作キャラに撤退されてしまった
				SIF ENEMY_TYPE_CHECK_F("AKUOTI") == 1
					CALL MESSAGE_OTHER_BATTLE_CHARA_TETTAI_SUCCESS
				
				BEGIN AFTERTRAIN
			ELSE
				;지문: 撤退失敗
				CALL MESSAGE_BATTLE_CHARA_TETTAI_FALSE
				;지문: 세뇌/흑화 캐릭터가 操作キャラの撤退を防いだ
				SIF ENEMY_TYPE_CHECK_F("AKUOTI") == 1
					CALL MESSAGE_OTHER_BATTLE_CHARA_TETTAI_FALSE
				JUMP SOURCE_CHECK
			ENDIF
		ENDIF
	ELSE
	ENDIF
ELSEIF RESULT == 800
	DRAWLINE
	CALL SHOW_STATUS_CHARA_SELECT, TARGET
ELSEIF RESULT == 810
	TCVARn:8 = 0
ELSEIF RESULT == 820
	TCVARn:8 = 1
ELSEIF RESULT == 830
	TCVARn:8 = 2
;調教스테이터스 표시설정
ELSEIF RESULT == 898
	INVERTBIT FLAG:801, 8
ELSEIF RESULT == 899
	INVERTBIT FLAG:801, 6
;デバッグモード切替(隠しコマンド)
ELSEIF RESULT == 400
	;DEBUG
	IF FLAG:999 == 0
		PRINTL 
		PRINTL 
		PRINTL DEBUG ON
		FLAG:999 = 1
		SETBGCOLOR 0,0,40
	ELSEIF FLAG:999 == 1
		PRINTL 
		PRINTL 
		PRINTL DEBUG OFF
		FLAG:999 = 0
		RESETBGCOLOR
	ENDIF
ELSEIF RESULT < 400
	LOCAL = RESULT
	TCVARn:8 += 10
	RESULT = 0
	TRYCALLFORM COM_ABLE{LOCAL}
	TCVARn:8 -= 10
	SIF RESULT
		DOTRAIN LOCAL
ENDIF

@EVENTCOM
;EX系は表示しない
SIF SELECTCOM == 16 || SELECTCOM == 17 || SELECTCOM == 71 || SELECTCOM == 72
	RETURN 0
;사정部位플래그를0に
TFLAG:4 = 0
;방어플래그를消す
TCVARn:2 = 자세：통상
;受け渡し用PALAMリセット
VARSET COMMON_PALAM

PRINTL 
FONTBOLD
SETCOLOR 0, 255, 150
PRINTL ********** 自分の行動 **********
RESETCOLOR
FONTREGULAR
PRINTL 

@EVENTCOMEND
#DIM LCOUNT
#DIM CCOUNT
;計算用
#DIM CHISEI_CAL
;PALAM減衰率
#DIM AT_VAR
CALL BATTLE_REPORT
;心境の持続ターンをカウント
SIF TCVARn:1 > 0
	TCVARn:11 += 1

;着地中または拘束中なら空中플래그를リセット
IF GETBIT(TCVARn:216, 2) || TCVARn:0 == 0
	TCVARn:216 = 0
	BASE:공중대시 = MAXBASE:공중대시
	SIF BASE:공중대시>= 8
		BASE:공중대시 = 8
;滞空状態で続けて공중대시を使用しないなら着地状態になる
ELSEIF GETBIT(TCVARn:216, 1) && GETBIT(TCVARn:216, 0) == 0
	SETBIT TCVARn:216,2
	SIF GETBIT(TCVARn:216, 1)
		TCVARn:216 -= 2
ENDIF

;공중대시ゲージが切れていたら空中공격플래그를リセット
SIF GETBIT (TCVARn:216, 0) && BASE:공중대시 == 0
	TCVARn:216 -= 1

;バースト공격フラグは常にリセット
TCVARn:217 = 0

;拘束中でなければ丸飲み플래그를解除
SIF TCVARn:0 != 0
	TFLAG:23 = 0

;拘束中なら同一距離플래그를解除
SIF TCVARn:0 == 0
	TFLAG:30 = 0
;拘束中ならチェインリセット
SIF TCVARn:0 == 0
	TFLAG:31 = 0
;방어コマンドを使用した次のターンはカウンターアタック
IF SELECTCOM == 4 && FLAG:73 == 0
	TFLAG:32 = 1
ELSE
	TFLAG:32 = 0
ENDIF

;衣装の情報を更新
CALL REFRESH_CLOTH_DATA

;ゲージ増減関連
IF CFLAG:1 == 2
	TCVARn:6 += -17
ELSE
	TCVARn:6 += 12
	;状態異常の場合、ゲージ増加量が上昇
	SIF (TCVARn:12 & 기절)
		TCVARn:6 += 23
	SIF (TCVARn:12 & 배란)
		TCVARn:6 += 3
	SIF (TCVARn:12 & 발정)
		TCVARn:6 += 3
	SIF (TCVARn:12 & 마비)
		TCVARn:6 += 8
	SIF (TCVARn:12 & 끈적끈적)
		TCVARn:6 += 5
	SIF (TCVARn:12 & 쓰러짐)
		TCVARn:6 += 8
	SIF (TCVARn:12 & 황홀)
		TCVARn:6 += 5
	SIF (TCVARn:12 & 강구속)
		TCVARn:6 += 2
	;増加量アップ系の補正
	IF TCVARn:6 > 0
		LOCAL = 0
		;変身可能キャラで変身前なら増加量2倍
		SIF TALENT:변신능력 > 0 && CFLAG:1 == 0
			LOCAL += 100
		;의욕 스위치#####
		SIF CFLAG:43 == 503
			LOCAL += 30
		;FEAT 효과에 따른ゲージ増加量低下
		SIF TALENT:불굴 > 0
			LOCAL -= 15
		SIF TALENT:스태미나 > 0
			LOCAL -= 15
		;衣装によるゲージ増幅効果
		CALL CLOTH_BATTLE_HOSEI, "EXBOOST"
		LOCAL += RESULT
		SIF LOCAL < -100
			LOCAL = -100
		TCVARn:6 = TCVARn:6 * (100 + LOCAL) / 100
	ENDIF
ENDIF

IF CFLAG:1 == 2
	TCVARn:5 += TCVARn:6
ELSE
	TCVARn:4 = LIMIT(TCVARn:4 + TCVARn:6, 0, 600)
	TCVARn:4 = LIMIT(TCVARn:4 + TCVARn:7, -100, 500)
ENDIF

;SP変身解除
IF TCVARn:5 <= 0 && CFLAG:1 == 2
	IF TALENT:변신능력
		CALL TRANSFORM, 1
	ELSE
		CALL TRANSFORM, 0
	ENDIF
	PRINTL 
	FONTBOLD
	;지문: SP변신解除
	PRINTFORML SP변신の効果時間が終了した！
	FONTREGULAR
	TCVARn:4 = -1
	;行動の反動で疲労が蓄積する
	CFLAG:99 += TFLAG:99
	RESULTS = {TFLAG:99}
	TOFULL RESULTS
	PRINTFORML %PRINT_CALLNAME(TARGET)%の身体の底に疲労が蓄積した……（＋%RESULTS%）
	PRINTW 
	TFLAG:99 = 0
ENDIF

;ゲージ使用状況플래그를リセット
TCVARn:3 = 0
;双方の増減をリセット
TCVARn:6 = 0
TCVARn:7 = 0

;촉수の太さと数を保存
REPEAT 감각수
	TFLAG:(COUNT + 101) = TENTACLE_SIZE:0:COUNT
	TFLAG:(COUNT + 105) = TENTACLE_NUM:1:COUNT
REND
TFLAG:109 = INSERT
;촉수サイズを초기화
VARSET TENTACLE_SIZE

;絶頂による変身解除、성내성が少ないほど発生率が上がる
LOCAL:2 = 0
REPEAT 감각수
	LOCAL:2 += NOWEX:(COUNT)
REND
CALL PERCENT_CAL, BASE:기력, MAXBASE:기력
LOCAL:4 = RESULT
CALL PERCENT_CAL, BASE:성내성, MAXBASE:성내성
LOCAL:3 = 100 - (RESULT * 4 / 3)

;暴走中の촉수 슈트だと解除されない
IF CFLAG:1 == 1 && CFLAG:41 == 199 && CFLAG:41 == 199 && TCVARn:41 != 0
;기력が尽きて変身が強制的に解けた場合の処理
ELSEIF CONFIG_CHECK_BALANCE_F(6) == 0 && CFLAG:1 == 1 && BASE:기력 <= 0 && (TCVARn:12 & 강구속) == 0
	PRINTL 
	;지문: 기력が尽きて変身が強制的に解けた
	CALL MESSAGE_BATTLE_CHARA_TRANSRELEASE
	;지문: 세뇌/흑화 캐릭터가 操作キャラを変身強制解除させた
	SIF ENEMY_TYPE_CHECK_F("AKUOTI") == 1
		CALL MESSAGE_OTHER_BATTLE_CHARA_TRANSRELEASE
	CALL TRANSFORM, 0
	
	;心境変化
	LOCAL = RAND:100
	IF LOCAL < 30
		CALL SHINKYOU_CHANGE, "IKARI_TEIKAN"
	ELSEIF LOCAL < 60
		CALL SHINKYOU_CHANGE, "REISEI_DOUYOU"
	ELSEIF LOCAL < 90
		CALL SHINKYOU_CHANGE, "KOUYOU_SYOUTIN"
	ENDIF
;絶頂で変身が強制解除される場合の処理
ELSEIF CONFIG_CHECK_BALANCE_F(6) == 0 && CFLAG:1 == 1 && LOCAL:2 > 0 && RAND:100 < LOCAL:3 && RESULT < 50 && (TCVARn:12 & 강구속) == 0
	PRINTL 
	;지문: 絶頂で変身が強制的に解けた
	CALL MESSAGE_BATTLE_CHARA_TRANSRELEASE_ECS
	;지문: 세뇌/흑화 캐릭터가 絶頂で変身強制解除させた
	SIF ENEMY_TYPE_CHECK_F("AKUOTI") == 1
		CALL MESSAGE_OTHER_BATTLE_CHARA_TRANSRELEASE_ECS
	CALL TRANSFORM, 0

	;心境変化
	LOCAL = RAND:100
	IF LOCAL < 30
		CALL SHINKYOU_CHANGE, "IKARI_TEIKAN"
	ELSEIF LOCAL < 60
		CALL SHINKYOU_CHANGE, "REISEI_DOUYOU"
	ELSEIF LOCAL < 90
		CALL SHINKYOU_CHANGE, "KOUYOU_SYOUTIN"
	ENDIF
ELSEIF CFLAG:1 == 1 && LOCAL:2 > 0 && RESULT < 50 && (TCVARn:12 & 기절) == 0
	PRINTL 
	PRINTFORML %조사처리(PRINT_TRANSCALLNAME(TARGET),"는")%기력を振り絞り何とか変身を維持した！
ENDIF

;보스の解析度を지성の基礎値に応じて上昇させる（実数値ではない）
IF ENEMY_TYPE_CHECK_F("AKUOTI") == 0 && FLAG:20 < 100
	LOCAL = MAX(BASE:지성 - 100, 1)
	;전투 지원による補正
	CALL CALC_CHISEI_SHIEN(2)
	LOCAL = RESULT
	;心境による増減
	IF TCVARn:1 == 2
		LOCAL /= 2
	ELSEIF TCVARn:1 == 4
		LOCAL += 5
	ELSEIF TCVARn:1 == 5
		LOCAL /= 3
	ENDIF
	LOCAL = RAND:5 + LOCAL/4 + LOCAL:1
	CALL TENTACLE_LEVEL
	SIF RESULT < 10
		LOCAL += 10 - RESULT / 3
	SIF TCVARn:2 != 자세：통상
		LOCAL += 2 + RAND:5
	;스카우터#####
	SIF CFLAG:TARGET:43 == 500
		LOCAL += 5 + RAND:6
	PRINTL 
	IF LOCAL > 0
		DRAWLINE
		PRINTFORML 敵の解析度が{LOCAL}％上がった！
	ELSE
		DRAWLINE
		PRINTFORML 敵の解析度は上がらなかった…
	ENDIF
	SIF FLAG:20 < 25 && FLAG:20 + LOCAL >= 25
		PRINTL 敵の체력最大値が判明した！
	SIF FLAG:20 < 50 && FLAG:20 + LOCAL >= 50
		PRINTL 敵の체력現在値が判明した！
	SIF FLAG:20 < 75 && FLAG:20 + LOCAL >= 75
		PRINTL 敵の能力基礎値が判明した！
	IF FLAG:20 < 100 && FLAG:20 + LOCAL >= 100
		PRINTL 敵の行動補正値が判明した！
		PRINTL 敵の油断度が判明した！
		PRINTL 敵の解析が完了した！
	ENDIF
	FLAG:20 += LOCAL
	SIF FLAG:20 > 100
		FLAG:20 = 100
	PRINTL 
ENDIF
;EXにNOWEXを加算
REPEAT 감각수
	EX:(COUNT) += NOWEX:(COUNT)
REND

PREVCOM = SELECTCOM

;絶頂禁止カウント
SIF TCVARn:0 == 0 && TCVARn:40 > 0
	TCVARn:40 -= 1

SETCOLOR 96, 96, 96
SIF FLAG:999 == 1
	PRINTFORML /* debug */ 絶頂禁止残ターン{TCVARn:40}
RESETCOLOR

AT_VAR = LIMIT(950 + PALAMLV_F(PALAM:공순) * 3 + PALAMLV_F(PALAM:욕정) * 3 + PALAMLV_F(PALAM:굴복) * 2 + PALAMLV_F(PALAM:공포) * 2, 950, 995)

;PALAM最大値を保存およびPALAMの減衰
FOR LCOUNT, 0, PALAM종점
	SIF PALAM:(LCOUNT) > MAX_PALAM:(LCOUNT)
		MAX_PALAM:(LCOUNT) = PALAM:(LCOUNT)

	SIF LCOUNT == 윤활
		CONTINUE
	PALAM:(LCOUNT) = PALAM:(LCOUNT) * AT_VAR / 1000
NEXT

;逃げ遅れ市民と野次馬が減る
LOCAL:1 = 0
FOR LOCAL,0,(FLAG:70 + FLAG:71)
	;一定確率で退避完了
	IF RAND:100 < 5 + TFLAG:0 + (TIME == 0) * 5 + (GETBATTLESITUATION("正体バレ不可") ? (FLAG:70 > 5 ? 50 # 15) # 0) && FLAG:70
		FLAG:70 -= 1
		LOCAL:1 += 1
	ENDIF
	IF RAND:100 < -10 + TFLAG:0 + (TIME == 0) * 5 + (FLAG:71 > 5 ? 50 # 0) && FLAG:71
		FLAG:71 -= 1
		LOCAL:1 += 1
	ENDIF
NEXT
IF LOCAL:1
	IF FLAG:72
		PRINTFORML 危険を感じた観衆が{LOCAL:1}人避難した！
	ELSE
		PRINTFORML {LOCAL:1}人の一般人が安全な場所まで避難できたようだ・・・
	ENDIF
	SIF FLAG:70 + FLAG:71 == 0
		PRINTFORML どうやら周囲の避難が完了したようだ！
	PRINTW 
ENDIF

;イベント特有のターンエンド処理
TRYCALLFORM EVENT_BATTLE_TURNEND_{FLAG:45}

;インスタントモードなら能力低下関数を呼び出す
IF GAME_OPTION_CHECK_F(OPTION_스탯저하있음)
	CALL INSTANT_ARG_DOWN
ENDIF
