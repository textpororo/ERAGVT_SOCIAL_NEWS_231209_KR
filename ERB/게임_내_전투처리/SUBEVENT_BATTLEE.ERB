;**********************************************************
;戦闘のサブイベント類
;AFTERTRAIN.ERBから呼ばれるものはSUBEVENT_BATTLEENDに
;AFTERCOM.ERBから呼ばれるものは各自個別の関数に

@SUBEVENT_BATTLEEND
;戦闘後自慰
;絶頂禁止の解放
SIF TCVARn:40 > 0
	CALL SUBEVENT_RELEASE_ECSTASY
;時間切れか勝利時（撤退も）に条件を満たせば自慰をする
SIF TFLAG:98 == 0 || TFLAG:98 == 1
	CALL SELF_BATTLEEND, TARGET

;これ以降はAFTERCOM.ERBから呼ばれる個別イベント

;----------------------------------------------------------
;サブイベントの計算前の초기화
@SUBEVENT_BATTLE_PRECALCRESET
VARSET NOWEX, 0

;----------------------------------------------------------
;흑화 캐릭터に敗北して犯される
@SUBEVENT_BATTLE_RAPED_ENEMY

;パラメータの取得は暫定値（β３）
;ベース値の明示的초기화
REPEAT 12
	LOCAL:COUNT = 0
REND
;굴복
LOCAL:8 = 2000
;치정
LOCAL:9 = 2000

;지문: レイプする側
CALL MESSAGE_OTHER_SUBEVENT_BATTLE_RAPE_ENEMY

;지문: 흑화 캐릭터に敗北して犯される
CALL MESSAGE_SUBEVENT_BATTLE_RAPED_ENEMY


;피간경험を加算
EXP:피간경험 += 1

;計算へ

;サブイベントの計算前の초기화
CALL SUBEVENT_BATTLE_PRECALCRESET

CALL PALAM_CAL, LOCAL:0, LOCAL:1, LOCAL:2, LOCAL:3, LOCAL:4, LOCAL:5, LOCAL:6, LOCAL:7, LOCAL:8, LOCAL:9, LOCAL:10, LOCAL:11

;----------------------------------------------------------
;악질 시민に敗北して犯される
@SUBEVENT_BATTLE_RAPED_CITIZEN

;지문: 악질 시민に敗北して犯される
CALL MESSAGE_SUBEVENT_BATTLE_RAPED_CITIZEN

;피간경험を加算
EXP:피간경험 += 1

;計算へ
;サブイベントの計算前の초기화
CALL SUBEVENT_BATTLE_PRECALCRESET
CALL PALAM_CAL, LOCAL:0, LOCAL:1, LOCAL:2, LOCAL:3, LOCAL:4, LOCAL:5, LOCAL:6, LOCAL:7, LOCAL:8, LOCAL:9, LOCAL:10, LOCAL:11


;----------------------------------------------------------
;촉수 구속구 강제 장착
@SUBEVENT_BATTLE_SETTENTACLECLOTH
SIF CFLAG:42 == 400
	RETURN 0

LOCAL = 0
IF CFLAG:1 == 0
	SIF (PERCENT_CAL_F(TCVARn:21,TCVARn:20) < CLOTH_OUTER_DEF || TCVARn:21 == 0) && (PERCENT_CAL_F(TCVARn:25,TCVARn:24) < CLOTH_INNER_DEF || TCVARn:25 == 0)
		LOCAL = 1
ELSE
	SIF (PERCENT_CAL_F(TCVARn:23,TCVARn:22) < CLOTH_OUTER_DEF || TCVARn:23 == 0) && (PERCENT_CAL_F(TCVARn:25,TCVARn:24) < CLOTH_INNER_DEF || TCVARn:25 == 0)
		LOCAL = 1
ENDIF

LOCAL:1 = 35 - MIN((FLAG:45>0 ? 1 # 0) * 12, 12)
IF LOCAL == 1 && RAND(100) < LOCAL:1
	CFLAG:42 = 400
	;지문: 촉수 구속구を着せられた
	CALL MESSAGE_SUBEVENT_BATTLE_SETTENTACLECLOTH
ENDIF

;----------------------------------------------------------
;촉수 구속구による被姦
@SUBEVENT_BATTLE_ACTTENTACLECLOTH
#DIM LCOUNT
SIF CFLAG:42 != 400
	RETURN 0

;取得パラメータ計算
;β２時点では微々たる上昇で
CALL SEX_COMEX, 0, 0, 15
REPEAT 12
	LOCAL:COUNT = RESULT:COUNT / 2
REND
SIF ISMALE()
	LOCAL:1 = 0

;지문: 촉수 구속구による被姦
CALL MESSAGE_SUBEVENT_BATTLE_ACTTENTACLECLOTH

;피간경험を加算
EXP:피간경험 += 1

;サブイベントの計算前の초기화
CALL SUBEVENT_BATTLE_PRECALCRESET

;計算へ
;CALL PALAM_CAL, LOCAL:0, LOCAL:1, LOCAL:2, LOCAL:3, LOCAL:4, LOCAL:5, LOCAL:6, LOCAL:7, LOCAL:8, LOCAL:9, LOCAL:10, LOCAL:11
;LOCALをPALAM補正に加算する
FOR LCOUNT, 0, 13
	IF LOCAL:LCOUNT > 0
		;体勢に関する補正
		CALL PALAM_HOSEI_POSE, LOCAL:LCOUNT
		LOCAL:LCOUNT = RESULT

		;성내성に関する補正
		CALL PALAM_HOSEI_SEITAISEI, LOCAL:LCOUNT
		LOCAL:LCOUNT = RESULT

		;素質に関する補正
		CALL PALAM_HOSEI_TALENT, LCOUNT, LOCAL:LCOUNT
		LOCAL:LCOUNT = RESULT

		;성격に関する補正
		CALL PALAM_HOSEI_SEIKAKU, LCOUNT, LOCAL:LCOUNT
		LOCAL:LCOUNT = RESULT

		;촉수に関する補正
		;CALL PALAM_HOSEI_TENTACLE, LCOUNT, LOCAL:LCOUNT
		;LOCAL:LCOUNT = RESULT

		;촉수중독に関する補正
		IF LCOUNT + PALAM시점 - 감각수 == 공순 || LCOUNT + PALAM시점 - 감각수 == 욕정 || LCOUNT + PALAM시점 - 감각수 == 굴복
			CALL PALAM_HOSEI_POISONING_TENTACLE, LOCAL:LCOUNT
			LOCAL:LCOUNT = RESULT
		ENDIF

		;ランダム性付与
		CALL PALAM_HOSEI_RANDOM, LOCAL:LCOUNT
		LOCAL:LCOUNT = RESULT
		
		;下限値の설정
		SIF LOCAL:LCOUNT <= 0
			LOCAL:LCOUNT = 1
		;上限値の설정
		SIF LOCAL:LCOUNT > 999999 && LCOUNT >= 감각수
			LOCAL:LCOUNT = 999999
	ENDIF
	COMMON_PALAM:LCOUNT += LOCAL:LCOUNT
NEXT

;----------------------------------------------------------
;絶頂禁止の解放
@SUBEVENT_RELEASE_ECSTASY
#DIM LCOUNT
SIF TCVARn:40 <= 0
	RETURN 0

VARSET NOWEX
FOR LCOUNT, 0, 감각수
	CALL PALAM_ECSTASY, LCOUNT, 0, LCOUNT, 0
NEXT

;絶頂回数と珠の取得
LOCAL = 0
REPEAT 감각수
	SIF NOWEX:COUNT > 0
		LOCAL += 1
REND
EXP:절정경험 += NOWEX:C절정 * LOCAL
JUEL:쾌C += 1000 * NOWEX:C절정 * LOCAL
EXP:절정경험 += NOWEX:V절정 * LOCAL
JUEL:쾌V += 1000 * NOWEX:V절정 * LOCAL
EXP:절정경험 += NOWEX:A절정 * LOCAL
JUEL:쾌A += 1000 * NOWEX:A절정 * LOCAL
EXP:절정경험 += NOWEX:B절정 * LOCAL
JUEL:쾌B += 1000 * NOWEX:B절정 * LOCAL

EXP:노출쾌락경험 += LOCAL

IF NOWEX:0 + NOWEX:1 + NOWEX:2 + NOWEX:3
	PRINTL 
	;지문: 絶頂禁止の解放
	SIF TFLAG:98 != 2
		CALL MESSAGE_SUBEVENT_BATTLE_RELEASE_ECSTASY
	;絶頂の表示
	IF NOWEX:C절정 == 1
		;지문: C絶頂
		CALL MESSAGE_SEX_ECSTASY_C
	ELSEIF NOWEX:C절정 > 1
		;지문: C強絶頂
		CALL MESSAGE_SEX_ECSTASY_C_HI, NOWEX:C절정
	ENDIF
	IF NOWEX:V절정 == 1
		;지문: V絶頂
		CALL MESSAGE_SEX_ECSTASY_V
	ELSEIF NOWEX:V절정 > 1
		;지문: V強絶頂
		CALL MESSAGE_SEX_ECSTASY_V_HI, NOWEX:V절정
	ENDIF
	IF NOWEX:A절정 == 1
		;지문: A絶頂
		CALL MESSAGE_SEX_ECSTASY_A
	ELSEIF NOWEX:A절정 > 1
		;지문: A強絶頂
		CALL MESSAGE_SEX_ECSTASY_A_HI, NOWEX:A절정
	ENDIF
	IF NOWEX:B절정 == 1
		;지문: B絶頂
		CALL MESSAGE_SEX_ECSTASY_B
	ELSEIF NOWEX:B절정 > 1
		;지문: B強絶頂
		CALL MESSAGE_SEX_ECSTASY_B_HI, NOWEX:B절정
	ENDIF
ENDIF
TCVARn:40 = 0


;---------------------------------------------------------------------------
;オート振り解きの処理
@AUTO_UNTANGLE
;기절中は不可
IF (TCVARn:12 & 기절)
	TFLAG:22 = 1
	RETURN
ENDIF
;황홀中は不可
IF (TCVARn:12 & 황홀)
	TFLAG:22 = 1
	RETURN
ENDIF
;わざと捕まった場合は不可
IF SELECTCOM == 69
	TFLAG:22 = 1
	RETURN
ENDIF
;악질 시민戦はテンポ悪いから不可
IF FLAG:73 > 0
	TFLAG:22 = 1
	RETURN
ENDIF

IF TCVARn:0 == 0
	IF TFLAG:22 > 0 || (TCVARn:12 & 강구속)
		TFLAG:22 = 1
		RETURN
	ENDIF
	;풀어낸다成功判定
	CALL ACT_HANTEI_CHARA_TO_TENTACLE, "HURIHODOKU"

	;確率判定
	IF RESULT == 1
		PRINTL 
		FONTBOLD
		PRINTL オート振り解き
		FONTREGULAR
		;지문: 풀어낸다
		CALL MESSAGE_BATTLE_CHARA_HURIHODOKU

		TCVARn:0 = 2
		TFLAG:4 = 0

		;지문: 풀어낸다成功
		CALL MESSAGE_BATTLE_CHARA_HURIHODOKU_SUCCESS
		;지문: 세뇌/흑화 캐릭터가 操作キャラに振り解かれてしまった
		SIF ENEMY_TYPE_CHECK_F("AKUOTI") == 1
			CALL MESSAGE_OTHER_BATTLE_CHARA_HURIHODOKU_SUCCESS

		;自動で戦闘メニューを選択する
		TCVARn:8 = 1

		;フラグ類をリセット
		TFLAG:1 = 0
		TFLAG:16 = -1
		TFLAG:17 = -1
		TFLAG:20 = -1
		IF ENEMY_TYPE_CHECK_F("AKUOTI") == 0
			CALL TENTACLE_ACCESS, "NAME"
		ELSEIF ENEMY_TYPE_CHECK_F("AKUOTI") == 1
			PRINTFORM %PRINT_TRANSCALLNAME(FLAG:111)%
		ENDIF
		PRINTL は体勢を立て直している・・・
		PRINTL 
	ELSE
		PRINTL 
		PRINTFORML %조사처리(PRINT_TRANSCALLNAME(TARGET),"는")%がっちり拘束されて身動きできない・・・
		PRINTL 
		TFLAG:22 = 1
	ENDIF
ELSE
	TFLAG:22 = 0
ENDIF




;---------------------------------------------------------------------------
;촉수服の処理
@SUBEVENT_BATTLE_ACTTENTACLESUIT
#DIM LCOUNT
SIF CFLAG:1 == 0 && CFLAG:40 != 199
	RETURN 0
SIF CFLAG:1 > 0 && CFLAG:41 != 199
	RETURN 0
VARSET LOCAL
;촉수 슈트の名前をLOCALSに代入
IF CFLAG:1 == 0 && CSTR:8 != ""
	LOCALS = %CSTR:8%
ELSEIF CSTR:9 != ""
	LOCALS = %CSTR:9%
ELSE
	LOCALS = %ITEMNAME:199%
ENDIF

IF BASE:성내성 > 0 && FIGURE_SPLIT(EQUIP:(CFLAG:1==0 ? 99 # 199), 4) != 4 && (FIGURE_SPLIT(EQUIP:(CFLAG:1==0 ? 99 # 199), 4) != 3 || RAND:100 >= 5)
	LOCAL = 7 + RAND:5 + FIGURE_SPLIT(EQUIP:(CFLAG:1==0 ? 99 # 199), 2) * 7
	SIF FIGURE_SPLIT(EQUIP:(CFLAG:1==0 ? 99 # 199), 3) > 0
		LOCAL += 2
	SELECTCASE FIGURE_SPLIT(EQUIP:(CFLAG:1==0 ? 99 # 199), 4)
		CASE 1
			TIMES LOCAL, 0.9
		CASE 2
			TIMES LOCAL, 0.8
		CASE 3
			TIMES LOCAL, 0.5
	ENDSELECT
	BASE:성내성 = MAX(BASE:성내성 - LOCAL, 0)
	PRINTL 
	PRINTFORML %조사처리(PRINT_TRANSCALLNAME(TARGET),"는")%성내성を{LOCAL}消費した！
	SIF BASE:성내성 == 0
		PRINTFORML %PRINT_TRANSCALLNAME(TARGET)%의 성내성が尽きてしまった！
	PRINTW 
ELSE
	PRINTL 
	;取得パラメータ計算
	CALL SEX_COMEX, 0, 0, 15
	REPEAT 12
		LOCAL:COUNT = RESULT:COUNT * (100 + FIGURE_SPLIT(EQUIP:(CFLAG:1==0 ? 99 # 199), 2) * 20) / 100
		SELECTCASE FIGURE_SPLIT(EQUIP:(CFLAG:1==0 ? 99 # 199), 4)
			CASE 1
				TIMES LOCAL:COUNT, 1.1
			CASE 2
				TIMES LOCAL:COUNT, 1.2
		ENDSELECT
	REND

	;지문: 촉수服による被姦
	CALL MESSAGE_SUBEVENT_BATTLE_ACTTENTACLESUIT
	IF TCVARn:0 == 0
		SELECTCASE TCVARn:2
			CASE 자세：아무것도안한다,자세：통상,자세：가만히있는다,자세：받아들인다
			CASEELSE
				TCVARn:2 = 자세：통상
		ENDSELECT
	ELSEIF ISMALE()
		LOCAL:1 = 0
	ELSEIF TCVARn:41 == 1
		IF PALAM:윤활 >= 500
			;快V
			TIMES LOCAL:1, 1.3
			;快A
			TIMES LOCAL:2, 1.3
			;윤활
			;LOCAL:4 = 2000

			;처녀なら고통が大量に入る
			IF TALENT:처녀 == 1 && CHECK_HOLYVIRGIN_F()==0
				LOCAL:10 += 10000
				TALENT:처녀 = -1
				CFLAG:206 = 4
				TCVARn:1 = 1
			ENDIF
		ELSE
			TCVARn:41 = 0
		ENDIF
	ELSEIF TCVARn:41 == 2
		;快V
		SIF TALENT:처녀 < 1
			TIMES LOCAL:1, 1.5
		;快A
		TIMES LOCAL:2, 1.5

	ELSEIF TCVARn:41 == 3
		IF TALENT:처녀 < 1 && ISFEMALE()
			FONTBOLD
			PRINTL 질내대량사정
			FONTREGULAR
			PRINTFORML %LOCALS%の촉수と%PRINT_TRANSCALLNAME(TARGET)%의 膣口の隙間から、収まりきらない精液が溢れ出した
			TRYCALLFORM KOJO_ROOT(CFLAG:6, "SEX_TENTACLE_SYASEI_VAGINA_HI")
			PRINTL 
		ENDIF
		FONTBOLD
		PRINTL 애널대량사정
		FONTREGULAR
		PRINTFORML 直腸に大量に流し込まれた精液により、%PRINT_TRANSCALLNAME(TARGET)%의 腹は%LOCALS%を押し上げ、
		PRINTFORML ぽっこりと膨らんでしまっている…
		TRYCALLFORM KOJO_ROOT(CFLAG:6, "SEX_TENTACLE_SYASEI_ANAL_HI")
		PRINTL 
		;快V
		SIF TALENT:처녀 < 1
			LOCAL:1 *= 2
		;快A
		LOCAL:2 *= 2

		;汚れ
		SIF ISFEMALE()
			STAIN:3 |= 4
		STAIN:4 |= 4
		;임신確率 出産後の中だし回数と今までの출산경험に応じ可能性が増える
		SIF TALENT:처녀 < 1
			CALL NINSIN_HANTEI,2,3,200

		EXP:정액경험 += 2
	ELSEIF TCVARn:41 >= 4
		IF TALENT:처녀 < 1 && ISFEMALE()
			FONTBOLD
			PRINTL 질내사정
			FONTREGULAR
			PRINTFORML %LOCALS%は%PRINT_TRANSCALLNAME(TARGET)%의 질내に精液を流し込んだ
			TRYCALLFORM KOJO_ROOT(CFLAG:6, "SEX_TENTACLE_SYASEI_VAGINA")
			PRINTL 
		ENDIF
		FONTBOLD
		PRINTL 애널사정
		FONTREGULAR
		PRINTFORML %LOCALS%は%PRINT_TRANSCALLNAME(TARGET)%의 直腸に精液を流し込んだ
		TRYCALLFORM KOJO_ROOT(CFLAG:6, "SEX_TENTACLE_SYASEI_ANAL")
		PRINTL 
		;快V
		TIMES LOCAL:1, 1.7
		;快A
		TIMES LOCAL:2, 1.7

		;임신確率 出産後の中だし回数と今までの출산경험に応じ可能性が増える
		SIF TALENT:처녀 < 1
			CALL NINSIN_HANTEI,1,3,200

		EXP:정액경험 += 1
	ENDIF

	;피간경험を加算
	EXP:피간경험 += 1

	IF TCVARn:0 == 0
		TCVARn:41 = -1
	ELSEIF TCVARn:41 == -1
		TCVARn:41 = 1
	ELSE
		TCVARn:41 ++
	ENDIF
	;サブイベントの計算前の초기화
	CALL SUBEVENT_BATTLE_PRECALCRESET

	;計算へ
	;LOCALをPALAM補正に加算する
	FOR LCOUNT, 0, 13
		IF LOCAL:LCOUNT > 0
			;体勢に関する補正
			CALL PALAM_HOSEI_POSE, LOCAL:LCOUNT
			LOCAL:LCOUNT = RESULT

			;성내성に関する補正
			CALL PALAM_HOSEI_SEITAISEI, LOCAL:LCOUNT
			LOCAL:LCOUNT = RESULT

			;素質に関する補正
			CALL PALAM_HOSEI_TALENT, LCOUNT, LOCAL:LCOUNT
			LOCAL:LCOUNT = RESULT

			;성격に関する補正
			CALL PALAM_HOSEI_SEIKAKU, LCOUNT, LOCAL:LCOUNT
			LOCAL:LCOUNT = RESULT

			;촉수に関する補正
			;CALL PALAM_HOSEI_TENTACLE, LCOUNT, LOCAL:LCOUNT
			;LOCAL:LCOUNT = RESULT

			;촉수중독に関する補正
			IF LCOUNT + PALAM시점 - 감각수 == 공순 || LCOUNT + PALAM시점 - 감각수 == 욕정 || LCOUNT + PALAM시점 - 감각수 == 굴복
				CALL PALAM_HOSEI_POISONING_TENTACLE, LOCAL:LCOUNT
				LOCAL:LCOUNT = RESULT
			ENDIF

			;ランダム性付与
			CALL PALAM_HOSEI_RANDOM, LOCAL:LCOUNT
			LOCAL:LCOUNT = RESULT
			
			;下限値の설정
			SIF LOCAL:LCOUNT <= 0
				LOCAL:LCOUNT = 1
			;上限値の설정
			SIF LOCAL:LCOUNT > 999999 && LCOUNT >= 감각수
				LOCAL:LCOUNT = 999999
		ENDIF
		COMMON_PALAM:LCOUNT += LOCAL:LCOUNT
	NEXT
ENDIF



;---------------------------------------------------------------------------
;발정によって배란してしまう（現状では種族：ケモミミのみ）
@HATUJOU_TO_HAIRAN
SIF TALENT:짐승족 == 0
	RETURN 0
SIF ISMALE()
	RETURN 0
SIF TALENT:임신 > 0
	RETURN 0
SIF (TCVARn:12 & 배란) > 0
	RETURN 0
SIF (TCVARn:12 & 발정) == 0
	RETURN 0
;毎ターンの発生率10%
SIF RAND:100 >= 10
	RETURN 0

IF TALENT:주관시점 > 0
	PRINTFORML 激しい動悸を感じる…
ELSE
	PRINTFORML 突如、%PRINT_CALLNAME(TARGET)%は激しい動悸に見舞われた。
ENDIF
PRINTFORML 媚薬の効果により、強制的に발정期を迎えさせられたことで
IF TFLAG:7 > 0
	SIF TFLAG:7 >= 2
		PRINTFORM たっぷりと
	PRINTFORM 子種を注がれた
ELSEIF	EXP:출산경험 >= 20
	PRINTFORM これまで幾度となく孕まされてきた
ENDIF
PRINTFORM %PRINT_CALLNAME(TARGET)%の
IF TALENT:주관시점 > 0 && TALENT:청순파 > 0
	PRINTFORM 下腹の奥
ELSE
	PRINTFORM %ESTRUS_TEXT_F(TARGET,"の")%子宮
ENDIF
PRINTFORM が
SIF !(MESSAGE_BRANCH_F(TARGET) & 타락) && !(MESSAGE_BRANCH_F(TARGET) & 쾌락굴복)
	PRINTFORM 意思に反して
SIF TFLAG:7 == 0 && EXP:출산경험 >= 20
	PRINTFORM 再び
IF TFLAG:7 == 0
	PRINTFORM キュンキュンと切なく疼き
	IF TALENT:주관시점 > 0
		PRINTFORML だす。
	ELSE
		PRINTFORML 、
		IF FLAG:96 == 0
			PRINTFORM 子作り交尾の
		ELSE
			PRINTFORM 子孫を宿す
		ENDIF
		PRINTFORML 準備を始めてしまう。
	ENDIF
ELSE
	PRINTFORM ジリジリと熱く火照
	IF TALENT:주관시점 > 0
		PRINTFORML っている。
	ELSE
		PRINTFORML り、
		PRINTFORML 子孫を宿そうとしている。
	ENDIF
ENDIF
PRINTW 
PRINTFORM %조사처리(PRINT_TRANSCALLNAME(TARGET),"는")%발정によって
FONTBOLD
SETCOLOR 150,0,250
PRINT [배란]
RESETCOLOR
FONTREGULAR
PRINTL してしまった！
PRINTW 
TCVARn:12 |= 배란

RETURN 1


